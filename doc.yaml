import io
import polars as pl
import psycopg

def copy_with_staging(conn, df: pl.DataFrame, target: str, staging: str, pk_cols: list[str]):
    # 1) staging : idéalement UNLOGGED pour accélérer
    with conn.cursor() as cur:
        cur.execute(f"TRUNCATE {staging}")

    buf = io.StringIO()
    df.write_csv(buf, include_header=False)
    buf.seek(0)
    cols = ", ".join(df.columns)

    # 2) COPY into staging
    with conn.cursor() as cur:
        with cur.copy(f"COPY {staging} ({cols}) FROM STDIN WITH (FORMAT csv)") as copy:
            copy.write(buf.getvalue())

    # 3) merge vers target avec gestion conflit
    conflict = ", ".join(pk_cols)
    with conn.cursor() as cur:
        cur.execute(f"""
            INSERT INTO {target} ({cols})
            SELECT {cols} FROM {staging}
            ON CONFLICT ({conflict}) DO NOTHING
        """)
    conn.commit()
