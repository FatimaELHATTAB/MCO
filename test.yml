
-- =========================================================
-- Unified TPN Schema (PostgreSQL)
-- Conventions:
--   * snake_case
--   * All business links via tpn_id (VARCHAR(18))
--   * Temporal validity: opened_at / closed_at (TIMESTAMPTZ)
--   * Audit: created_at / updated_at (TIMESTAMPTZ)
--   * No 'Fast-Track' lifecycle option
-- =========================================================

-- Core register of TPNs (stable business key)
CREATE TABLE tpn_party (
    tpn_id          VARCHAR(18) PRIMARY KEY,
    created_at      TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at      TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- =========================
-- 1) Base Certifiée (facts)
-- =========================
CREATE TABLE tpn_base_certified (
    base_id                 BIGSERIAL PRIMARY KEY,
    tpn_id                  VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    -- temporal validity
    opened_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at               TIMESTAMPTZ,
    CONSTRAINT chk_bc_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    -- audit
    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- main fields
    rf_rmpm                 BOOLEAN,             -- RMPM Existence Flag
    comp_name               VARCHAR(100),
    incrp_count             CHAR(2),             -- ISO2 country (incorporation/legal registration)
    d_incorp                DATE,                -- Incorporation Date
    n_emp                   INTEGER,             -- Number of employees

    leg_form                VARCHAR(20),         -- N011 code
    d_lei_cert              DATE,                -- LEI re-certification date
    d_immat_lei             DATE,                -- LEI registration date
    s_lei                   VARCHAR(10),         -- 'Valid', 'Invalid', ...

    vat_num                 VARCHAR(18),
    sta_vat_num             VARCHAR(30),         -- Confirmed, Blank, Manual N°
    loc_act_code_type       VARCHAR(30),
    loc_act_code            VARCHAR(10),
    nace_code               VARCHAR(5),

    tp_rel_own              VARCHAR(10),         -- nomenclature "Site en relation"
    business_cntry          CHAR(2),             -- ISO2
    legal_status            VARCHAR(2),          -- e.g. 'E' ceased activity

    reg_req                 VARCHAR(30),         -- Registration requester
    data_share_stat         VARCHAR(20),         -- Shareable / Not Shareable...
    data_source             VARCHAR(11),         -- RM, RPK, ORS, SAFIR, OE, CIB/IB...
    cert_status             VARCHAR(9),          -- Trusted / Certified
    cert_owner              VARCHAR(50),
    val_dat                 TIMESTAMPTZ,         -- Value timestamp if present

    csr_flag                BOOLEAN,
    c_typo                  VARCHAR(2)
);

CREATE INDEX idx_bc_tpn ON tpn_base_certified(tpn_id);
CREATE INDEX idx_bc_current ON tpn_base_certified(tpn_id) WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_base_certified_current AS
SELECT *
FROM tpn_base_certified
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();

-- ==================================
-- 2) Company Identifiers (SIREN/LEI)
-- ==================================
CREATE TABLE tpn_company_identifier (
    comp_ident_id       BIGSERIAL PRIMARY KEY,
    tpn_id              VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_ci_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    comp_id             VARCHAR(30) NOT NULL,    -- identifier value
    comp_id_nat         VARCHAR(22),             -- nature: National registry, Market Data, BNPP BIS, ...
    comp_id_name        VARCHAR(20),             -- SIREN, LEI, sustainable_id, REUTERS_ID, ORBIS_ID, ...
    comp_id_source      VARCHAR(20)              -- Infogreffe, INPI, GLEIF, Reuters, Orbis, Sustainalytics, ...
);

CREATE UNIQUE INDEX ux_ci_identity_open
  ON tpn_company_identifier (tpn_id, comp_id_name, comp_id_source, comp_id, opened_at);

CREATE INDEX idx_ci_tpn_current ON tpn_company_identifier(tpn_id)
  WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_company_identifier_current AS
SELECT *
FROM tpn_company_identifier
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();

-- ======================
-- 3) Addresses (version)
-- ======================
CREATE TABLE tpn_address (
    address_id              BIGSERIAL PRIMARY KEY,
    tpn_id                  VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    opened_at               TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at               TIMESTAMPTZ,
    CONSTRAINT chk_addr_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at              TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at              TIMESTAMPTZ NOT NULL DEFAULT now(),

    address_type            CHAR(1),                     -- 'L' = Legal
    address_distribution    VARCHAR(70),
    address_way             VARCHAR(70),
    address_hamlet          VARCHAR(70),
    address_postcode_city   VARCHAR(70),
    address_country         CHAR(2),                     -- ISO2

    dept_iso                VARCHAR(2),
    subdept_iso             VARCHAR(70),
    building_name_iso       VARCHAR(35),
    floor_iso               VARCHAR(35),
    room_iso                VARCHAR(70),
    street_name_iso         VARCHAR(70),
    building_number_iso     VARCHAR(16),
    post_box_iso            VARCHAR(16),
    town_location_name_iso  VARCHAR(35),
    post_code_iso           VARCHAR(16),
    town_name_iso           VARCHAR(35),
    country_iso             CHAR(2),
    district_name_iso       VARCHAR(35),
    country_subdivision_iso VARCHAR(35)
);

CREATE INDEX idx_addr_tpn_current ON tpn_address(tpn_id) WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_address_current AS
SELECT *
FROM tpn_address
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();

-- =====================================
-- 4) Lifecycle (no 'Fast-Track' allowed)
-- =====================================
CREATE TABLE tpn_lifecycle (
    lifecycle_id        BIGSERIAL PRIMARY KEY,
    tpn_id              VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_lc_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    -- From sheet: ENT_REL + STAT_ORI_IMMAT (TP Lifecycle Status)
    ent_rel             VARCHAR(5),               -- code from "Site en relation" nomenclature
    lifecycle_status    VARCHAR(100)              -- 'No restriction' or 'Standard'
        CONSTRAINT chk_lifecycle_status CHECK (lifecycle_status IN ('No restriction','Standard'))
);

CREATE INDEX idx_lifecycle_tpn_current ON tpn_lifecycle(tpn_id) WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_lifecycle_current AS
SELECT *
FROM tpn_lifecycle
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();

-- =====================================
-- 5) Relationship Nature with BNPP (N148)
-- =====================================
CREATE TABLE tpn_bnpp_relation (
    bnpp_rel_id         BIGSERIAL PRIMARY KEY,
    tpn_id              VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_bnpp_rel_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    ent_rel             VARCHAR(5) NOT NULL,     -- "Site en relation"
    rel_nature_code     CHAR(1)                  -- N148 one-letter code
);

CREATE INDEX idx_bnpp_rel_tpn_current ON tpn_bnpp_relation(tpn_id) WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_bnpp_relation_current AS
SELECT *
FROM tpn_bnpp_relation
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();

-- ============================
-- 6) Absorptions (M&A tracking)
-- ============================
CREATE TABLE tpn_absorption (
    absorption_id       BIGSERIAL PRIMARY KEY,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_abs_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    tpn_id_absorbing    VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,
    tpn_id_absorbed     VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,
    absorbing_status    VARCHAR(10) NOT NULL CHECK (absorbing_status IN ('Pending','Passed'))
);

CREATE INDEX idx_abs_current ON tpn_absorption(tpn_id_absorbing, tpn_id_absorbed)
  WHERE closed_at IS NULL OR closed_at >= now();

-- ============================
-- 7) Deduplication tracking
-- ============================
CREATE TABLE tpn_deduplication (
    dedup_id            BIGSERIAL PRIMARY KEY,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_dedup_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    tpn_id_reference    VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,
    tpn_id_replaced     VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,
    dedup_status        VARCHAR(10) NOT NULL CHECK (dedup_status IN ('Pending','Passed'))
);

CREATE INDEX idx_dedup_current ON tpn_deduplication(tpn_id_reference, tpn_id_replaced)
  WHERE closed_at IS NULL OR closed_at >= now();

-- ============================
-- 8) ISIN Codes per TPN
-- ============================
CREATE TABLE tpn_isin_code (
    isin_id             BIGSERIAL PRIMARY KEY,
    tpn_id              VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    opened_at           TIMESTAMPTZ NOT NULL DEFAULT now(),
    closed_at           TIMESTAMPTZ,
    CONSTRAINT chk_isin_period CHECK (closed_at IS NULL OR closed_at >= opened_at),

    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now(),

    isin_code           CHAR(12) NOT NULL
        CONSTRAINT chk_isin_format CHECK (isin_code ~ '^[A-Z0-9]{12}$')
);

CREATE INDEX idx_isin_tpn ON tpn_isin_code(tpn_id);
CREATE INDEX idx_isin_current ON tpn_isin_code(tpn_id) WHERE closed_at IS NULL OR closed_at >= now();

CREATE OR REPLACE VIEW v_tpn_isin_current AS
SELECT *
FROM tpn_isin_code
WHERE (closed_at IS NULL OR closed_at >= now())
  AND opened_at <= now();


-- ============================
-- 9) Matching & Dedup support (v3: score 0..100)
-- ============================
CREATE TABLE tpn_matching (
    matching_id         BIGSERIAL PRIMARY KEY,
    tpn_id              VARCHAR(18) NOT NULL REFERENCES tpn_party(tpn_id) ON DELETE CASCADE,

    -- Matched identifier (target side)
    comp_id             VARCHAR(30) NOT NULL,
    comp_id_source      VARCHAR(20),                 -- Infogreffe, GLEIF, Reuters, Orbis, ...

    -- Scoring / rule
    matching_rule       VARCHAR(100) NOT NULL,       -- name/key of the applied rule
    confidence_score    NUMERIC(5,2) NOT NULL,       -- 0.00 .. 100.00
    CONSTRAINT chk_tm_conf CHECK (confidence_score >= 0 AND confidence_score <= 100),

    -- Clustering & dedup
    cluster_id          VARCHAR(64),
    dedup_decision      VARCHAR(20),                  -- free text (kept "libre" as requested)
    dedup_decision_old  VARCHAR(20),
    cluster_id_old      VARCHAR(64),
    dedup_date          TIMESTAMPTZ,
    dedup_user          VARCHAR(100),

    -- Geo
    country             CHAR(2),                      -- ISO2 if provided

    -- Audit
    created_at          TIMESTAMPTZ NOT NULL DEFAULT now(),
    updated_at          TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Useful indexes
CREATE INDEX idx_tm_tpn ON tpn_matching(tpn_id);
CREATE INDEX idx_tm_comp ON tpn_matching(comp_id, comp_id_source);
CREATE INDEX idx_tm_cluster ON tpn_matching(cluster_id);
CREATE INDEX idx_tm_decision ON tpn_matching(dedup_decision);

-- Prevent exact duplicates of a scoring result at the same created_at instant
CREATE UNIQUE INDEX ux_tm_unique_event
  ON tpn_matching(tpn_id, comp_id, comp_id_source, matching_rule, created_at);
